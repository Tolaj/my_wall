<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <style>
        .event-dots {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin-top: 2px;
        }

        .event-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        #calendarDragDialog {
            -webkit-app-region: drag;
        }

        .no-drag {
            -webkit-app-region: no-drag;
        }
    </style>
</head>

<body>
    <div id="calendarDialog" class="bg-transparent" style="width: 300px;">
        <div id="calendarContainer" class="rounded-2xl">
            <div id="calendarDragDialog" class="p-4 px-6 flex items-center justify-between">
                <span class="text-base font-bold" id="monthYear">October 2025</span>
                <div class="flex items-center no-drag">
                    <button id="prevBtn" aria-label="calendar backward" class="hover:opacity-70">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left"
                            width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <polyline points="15 6 9 12 15 18" />
                        </svg>
                    </button>
                    <button id="nextBtn" aria-label="calendar forward" class="hover:opacity-70 ml-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right"
                            width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <polyline points="9 6 15 12 9 18" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-between pt-4 p-2 overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Mo</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Tu</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">We</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Th</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Fr</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Sa</p>
                                </div>
                            </th>
                            <th>
                                <div class="w-full flex justify-center">
                                    <p class="text-base font-medium text-center day-header">Su</p>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        <!-- Days will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="py-4 bg-transparent rounded-b" id="eventsSection">
            <div class="px-4">
                <p class="text-center text-gray-400">Loading events...</p>
            </div>
        </div>
    </div>
    <script>
        const { ipcRenderer } = require("electron");

        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];

        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let todayDateKey = `${currentDate.getFullYear()}-${currentMonth + 1}-${currentDate.getDate()}`;
        let selectedDate = todayDateKey;
        let resizeTimeout = null;
        let events = {};
        let selectedEventId = null;
        let timezone = 'UTC';

        // Theme settings with defaults
        let theme = {
            calendarBgColor: '#ffffff',
            calendarBgOpacity: 80,
            eventBgColor: '#ffffff',
            eventBgOpacity: 90,
            calendarTextColor: '#000000',
            eventTextColor: '#000000',
            insightColor: '#4f46e5',
            insightTextColor: '#ffffff'
        };

        // Get current date in specified timezone
        function getCurrentDateInTimezone() {
            const now = new Date();
            const tzDate = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
            return {
                year: tzDate.getFullYear(),
                month: tzDate.getMonth(),
                day: tzDate.getDate(),
                dateKey: `${tzDate.getFullYear()}-${tzDate.getMonth() + 1}-${tzDate.getDate()}`
            };
        }

        // Update today's date based on timezone
        function updateTodayDate() {
            const tzDate = getCurrentDateInTimezone();
            todayDateKey = tzDate.dateKey;


            selectedDate = todayDateKey;

        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('global_settings') || '{}');

            if (saved.calendarSettings) {
                if (saved.calendarSettings.timezone) {
                    timezone = saved.calendarSettings.timezone;
                }

                if (saved.calendarSettings.theme) {
                    theme = { ...theme, ...saved.calendarSettings.theme };
                }
            }

            updateTodayDate();
            applyTheme();
        }

        // Listen for settings updates from main process
        ipcRenderer.on('apply-calendar-settings', (event, settings) => {
            if (settings.calendarSettings) {
                const timezoneChanged = settings.calendarSettings.timezone &&
                    settings.calendarSettings.timezone !== timezone;

                if (timezoneChanged) {
                    timezone = settings.calendarSettings.timezone;
                    updateTodayDate();

                }

                if (settings.calendarSettings.theme) {
                    theme = { ...theme, ...settings.calendarSettings.theme };
                    applyTheme();
                }

                renderCalendar();
            }
        });

        // Apply theme colors to the calendar
        function applyTheme() {
            const calendarContainer = document.getElementById('calendarContainer');
            const monthYear = document.getElementById('monthYear');
            const dayHeaders = document.querySelectorAll('.day-header');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            // Apply calendar background with opacity
            const calendarBgRgba = hexToRgba(theme.calendarBgColor, theme.calendarBgOpacity / 100);
            calendarContainer.style.backgroundColor = calendarBgRgba;

            // Apply calendar text color
            monthYear.style.color = theme.calendarTextColor;
            dayHeaders.forEach(header => {
                header.style.color = theme.calendarTextColor;
            });
            prevBtn.style.color = theme.calendarTextColor;
            nextBtn.style.color = theme.calendarTextColor;

            // Update event dots color
            const style = document.createElement('style');
            style.textContent = `
                .event-dot {
                    background-color: ${theme.insightColor} !important;
                }
            `;
            document.head.appendChild(style);

            // Re-render calendar to apply colors
            renderCalendar();
            if (selectedDate) {
                displayEvents(selectedDate);
            }
        }

        // Convert hex to rgba with opacity
        function hexToRgba(hex, opacity) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // ============================================
        // EVENT FILTER TOGGLES
        // ============================================
        const SHOW_LECTURES = false;
        const SHOW_ASSIGNMENTS = true;
        const SHOW_OTHERS = true;

        function categorizeEvent(summary, description) {
            const text = (summary + ' ' + description).toLowerCase();

            if (text.includes('zoom')) {
                return 'lecture';
            }

            if (text.includes('assignment') || text.includes('homework') || text.includes('due') ||
                text.includes('submit') || text.includes('lab') || text.includes('project') ||
                text.includes('proposal') || text.includes('quiz') || text.includes('exam') ||
                text.includes('test') || text.includes('deadline') || text.includes('submission') ||
                text.includes('deliverable')) {
                return 'assignment';
            }

            return 'other';
        }

        function shouldShowEvent(category) {
            if (category === 'lecture') return SHOW_LECTURES;
            if (category === 'assignment') return SHOW_ASSIGNMENTS;
            if (category === 'other') return SHOW_OTHERS;
            return true;
        }

        function parseICS(icsText) {
            const parsedEvents = {};

            try {
                const jcalData = ICAL.parse(icsText);
                const comp = new ICAL.Component(jcalData);
                const vevents = comp.getAllSubcomponents('vevent');
                vevents.forEach(vevent => {
                    const event = new ICAL.Event(vevent);

                    const summary = event.summary || '';
                    const description = event.description || '';

                    const category = categorizeEvent(summary, description);

                    if (!shouldShowEvent(category)) return;

                    const startDate = event.startDate;
                    const year = startDate.year;
                    const month = startDate.month;
                    const day = startDate.day;
                    const dateKey = `${year}-${month}-${day}`;

                    const isAllDay = !startDate.hour && !startDate.minute && !startDate.second;

                    let timeString;
                    if (isAllDay) {
                        timeString = 'All Day';
                    } else {
                        const hour = startDate.hour;
                        const minute = startDate.minute;
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const displayHour = hour % 12 || 12;
                        const displayMinute = minute.toString().padStart(2, '0');
                        timeString = `${displayHour}:${displayMinute} ${ampm}`;
                    }

                    let preview = description
                        .replace(/\n/g, ' ')
                        .trim();

                    if (preview.length > 50) preview = preview.substring(0, 44) + '...';

                    if (!parsedEvents[dateKey]) {
                        parsedEvents[dateKey] = [];
                    }

                    parsedEvents[dateKey].push({
                        time: timeString,
                        title: summary,
                        description: preview,
                        fullDescription: description,
                        category: category
                    });
                });

            } catch (error) {
                console.error('Error parsing ICS:', error);
            }

            return parsedEvents;
        }

        async function loadCalendarEvents() {
            try {
                const response = await fetch('https://sit.instructure.com/feeds/calendars/user_36bsgfSVp15OSV5Mkynh29Ilbp4RzNLT6457MQxm.ics');
                const icsText = await response.text();
                events = parseICS(icsText);
                renderCalendar();
                displayEvents(todayDateKey);
                setTimeout(() => {
                    sendCurrentSize();
                }, 100);
            } catch (error) {
                console.error('Failed to load calendar events:', error);
                events = {};
                renderCalendar();
                displayEvents(todayDateKey);
            }
        }

        function getEventDots(count) {
            if (count === 0) return '';
            const dotsToShow = Math.min(count, 3);
            let dotsHTML = '<div class="event-dots">';
            for (let i = 0; i < dotsToShow; i++) {
                dotsHTML += '<div class="event-dot"></div>';
            }
            dotsHTML += '</div>';
            return dotsHTML;
        }

        function renderCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get today's date in the current timezone
            const tzToday = getCurrentDateInTimezone();
            const isCurrentMonth = currentYear === tzToday.year && currentMonth === tzToday.month;
            const todayDate = tzToday.day;

            const firstDay = new Date(currentYear, currentMonth, 1);
            let startingDayOfWeek = firstDay.getDay() - 1;
            if (startingDayOfWeek < 0) startingDayOfWeek = 6;

            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();

            let dayCount = 1;
            let rows = Math.ceil((daysInMonth + startingDayOfWeek) / 7);

            for (let week = 0; week < rows; week++) {
                const row = document.createElement('tr');

                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    cell.className = week === 0 ? 'pt-6' : '';

                    const cellIndex = week * 7 + day;

                    if (cellIndex < startingDayOfWeek || dayCount > daysInMonth) {
                        cell.innerHTML = '<div class="px-2 py-2 flex w-full justify-center" style="min-height: 40px;"></div>';
                    } else {
                        const dateKey = `${currentYear}-${currentMonth + 1}-${dayCount}`;
                        const isSelected = selectedDate === dateKey;
                        console.log(isSelected, dateKey, dayCount)
                        const isToday = isCurrentMonth && dayCount === todayDate;
                        const eventCount = events[dateKey] ? events[dateKey].length : 0;
                        const eventDots = getEventDots(eventCount);

                        if (isSelected) {
                            cell.innerHTML = `
                                <div class="w-full h-full" style="min-height: 40px;">
                                    <div class="flex flex-col items-center justify-center w-full cursor-pointer">
                                        <a class="focus:outline-none focus:ring-2 focus:ring-offset-2 text-base w-8 h-8 flex items-center justify-center font-medium rounded-full" style="background-color: ${theme.insightColor}; color: ${theme.insightTextColor};" data-date="${dateKey}">${dayCount}</a>
                                        ${eventDots}
                                    </div>
                                </div>`;
                        } else if (isToday) {
                            cell.innerHTML = `
                                <div class=" cursor-pointer flex flex-col  hover:opacity-70 items-center justify-center w-full" style="min-height: 40px; color: ${theme.insightColor};" data-date="${dateKey}">
                                    <p class="text-base flex items-center justify-center bg-slate-100 underline rounded-full w-8 h-8 font-bold" style="color: ${theme.insightTextColor};">${dayCount}</p>
                                    ${eventDots}
                                </div>`;
                        } else {
                            cell.innerHTML = `
                                <div class="px-2 py-2 cursor-pointer flex flex-col rounded-full hover:opacity-70 items-center justify-center w-full" style="min-height: 40px; color: ${theme.calendarTextColor};" data-date="${dateKey}">
                                    <p class="text-base font-medium opacity-60">${dayCount}</p>
                                    ${eventDots}
                                </div>`;
                        }
                        dayCount++;
                    }

                    row.appendChild(cell);
                }

                calendarBody.appendChild(row);
            }

            addDateClickListeners();
        }

        function addDateClickListeners() {
            document.querySelectorAll('[data-date]').forEach(elem => {
                elem.addEventListener('click', function () {
                    const clickedDate = this.getAttribute('data-date');

                    if (selectedDate === clickedDate) {
                        selectedDate = null;
                        selectedEventId = null;
                        document.getElementById('eventsSection').style.display = 'none';
                    } else {
                        selectedDate = clickedDate;
                        selectedEventId = null;
                        displayEvents(selectedDate);
                        document.getElementById('eventsSection').style.display = 'block';
                    }

                    renderCalendar();
                    debouncedSendSize();
                });
            });
        }

        function displayEvents(dateKey) {
            const eventsSection = document.getElementById('eventsSection');
            const dayEvents = events[dateKey] || [];

            const eventBgRgba = hexToRgba(theme.eventBgColor, theme.eventBgOpacity / 100);

            if (dayEvents.length === 0) {
                eventsSection.innerHTML = `
                    <div class="px-4">
                        <p class="text-center" style="color: ${theme.eventTextColor}; opacity: 0.5;">No events for this date</p>
                    </div>`;
            } else if (selectedEventId !== null) {
                const event = dayEvents[selectedEventId];
                eventsSection.innerHTML = `
                    <div class="space-y-1">
                        <div class="p-3 rounded-2xl" style="background-color: ${eventBgRgba}; color: ${theme.eventTextColor};">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-xs font-light leading-3" style="opacity: 0.7;">${event.time}</p>
                                <button onclick="closeEventDetails()" class="hover:opacity-70" style="color: ${theme.eventTextColor};">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                            <h3 class="text-base font-bold mb-2">${event.title}</h3>
                            <div class="text-xs leading-relaxed whitespace-pre-wrap overflow-y-auto" style="max-height: 200px; opacity: 0.8;">${event.fullDescription || event.description || 'No description available'}</div>
                        </div>
                    </div>`;
            } else {
                let eventsHTML = '<div class="space-y-1">';
                dayEvents.forEach((event, index) => {
                    const marginClass = index > 0 ? 'mt-1' : '';
                    eventsHTML += `
                        <div class="${marginClass} p-2 rounded-2xl cursor-pointer hover:opacity-80 transition-opacity" style="background-color: ${eventBgRgba}; color: ${theme.eventTextColor};" onclick="showEventDetails(${index})">
                            <p class="text-xs font-light leading-3" style="opacity: 0.7;">${event.time}</p>
                            <a class="focus:outline-none text-sm font-medium leading-5 mt-1 block">${event.title}</a>
                            ${event.description ? `<p class="text-xs pt-1 leading-4" style="opacity: 0.8;">${event.description}</p>` : ''}
                        </div>`;
                });
                eventsHTML += '</div>';
                eventsSection.innerHTML = eventsHTML;
            }
        }

        window.showEventDetails = function (eventIndex) {
            selectedEventId = eventIndex;
            displayEvents(selectedDate);
            debouncedSendSize();
        };

        window.closeEventDetails = function () {
            selectedEventId = null;
            displayEvents(selectedDate);
            debouncedSendSize();
        };

        document.getElementById('prevBtn').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            selectedDate = null;
            selectedEventId = null;
            document.getElementById('eventsSection').style.display = 'none';
            renderCalendar();
            debouncedSendSize();
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            selectedDate = null;
            selectedEventId = null;
            document.getElementById('eventsSection').style.display = 'none';
            renderCalendar();
            debouncedSendSize();
        });

        function sendCurrentSize() {
            const rect = document.getElementById('calendarDialog').getBoundingClientRect();
            ipcRenderer.send('resize-calendar', {
                width: Math.ceil(rect.width),
                height: Math.ceil(rect.height)
            });
        }

        function debouncedSendSize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                sendCurrentSize();
            }, 50);
        }

        // Initialize
        loadSettings();
        loadCalendarEvents();
    </script>
</body>

</html>
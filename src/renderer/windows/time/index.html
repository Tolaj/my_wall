<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Lato&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Arial&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Georgia&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Verdana&display=swap");

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .time-card {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            width: fit-content;
            height: fit-content;
        }

        .display-time {
            position: relative;
            z-index: 10;
            font-size: 5rem;
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 5px;
            transition: ease-in-out 0.1s;
            transition-property: background, box-shadow, color, border-color, font-family;
            -webkit-box-reflect: below 2px linear-gradient(transparent, rgba(255, 255, 255, 0.05));
            white-space: nowrap;
        }

        .display-time:hover {
            cursor: pointer;
        }

        #timeDialog {
            -webkit-app-region: drag;
            overflow: hidden;
            width: fit-content;
            height: fit-content;
        }

        #vanta-bg {
            position: absolute;
            inset: 0;
            opacity: 0.3;
        }
    </style>
</head>

<body>
    <div id="timeDialog">
        <div id="timeDialogHead" class="time-card">
            <div id="vanta-bg"></div>
            <div class="display-time">00:00:00</div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require("electron");

        let vantaEffect = null;
        let resizeTimeout = null;
        let timezone = 'UTC';
        let showSeconds = true; // Default to showing seconds
        let previousShowSeconds = true; // Track previous state
        let previousBgCoverEnabled = true; // Track previous background state

        // Theme settings with defaults
        let theme = {
            bgColor: '#ffd868',
            bgOpacity: 100,
            borderColor: '#ffd868',
            borderOpacity: 100,
            textColor: '#ffd868',
            fontFamily: 'Lato',
            fontSize: 5,
            bgCoverEnabled: true
        };

        // Initialize Vanta.js background
        function initVanta() {
            if (vantaEffect) {
                vantaEffect.destroy();
            }

            vantaEffect = VANTA.WAVES({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: 0x1a1a2e,
                shininess: 30.00,
                waveHeight: 15.00,
                waveSpeed: 0.75,
                zoom: 0.65
            });
        }

        // Toggle Vanta background visibility
        function toggleVantaBackground(enabled) {
            const vantaBg = document.getElementById('vanta-bg');
            if (vantaBg) {
                vantaBg.style.display = enabled ? 'block' : 'none';
            }

            // Reinitialize Vanta when toggled on
            if (enabled && !vantaEffect) {
                initVanta();
            } else if (!enabled && vantaEffect) {
                vantaEffect.destroy();
                vantaEffect = null;
            }
        }

        const displayTime = document.querySelector(".display-time");

        // Load settings from localStorage
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('global_settings') || '{}');

            if (saved.timeSettings) {
                if (saved.timeSettings.timezone) {
                    timezone = saved.timeSettings.timezone;
                }

                if (saved.timeSettings.showSeconds !== undefined) {
                    showSeconds = saved.timeSettings.showSeconds;
                    previousShowSeconds = showSeconds;
                }

                if (saved.timeSettings.theme) {
                    theme = { ...theme, ...saved.timeSettings.theme };
                    previousBgCoverEnabled = theme.bgCoverEnabled ?? true;
                }
            }

            applyTheme();
        }

        // Listen for settings updates from main process
        ipcRenderer.on('apply-time-settings', (event, settings) => {
            if (settings.timeSettings) {
                if (settings.timeSettings.timezone) {
                    timezone = settings.timeSettings.timezone;
                }

                if (settings.timeSettings.showSeconds !== undefined) {
                    const newShowSeconds = settings.timeSettings.showSeconds;
                    // Check if showSeconds changed
                    if (newShowSeconds !== previousShowSeconds) {
                        showSeconds = newShowSeconds;
                        previousShowSeconds = newShowSeconds;
                        // Force immediate size recalculation
                        updateTimeDisplay();
                        setTimeout(() => {
                            sendCurrentSize();
                        }, 100);
                    }
                }

                if (settings.timeSettings.theme) {
                    const newBgCoverEnabled = settings.timeSettings.theme.bgCoverEnabled ?? true;
                    // Check if background cover setting changed
                    if (newBgCoverEnabled !== previousBgCoverEnabled) {
                        previousBgCoverEnabled = newBgCoverEnabled;
                        theme = { ...theme, ...settings.timeSettings.theme };
                        applyTheme();
                        // Force Vanta reinitialize after a small delay
                        setTimeout(() => {
                            if (newBgCoverEnabled) {
                                initVanta();
                            }
                            sendCurrentSize();
                        }, 100);
                    } else {
                        theme = { ...theme, ...settings.timeSettings.theme };
                        applyTheme();
                    }
                }

                debouncedSendSize();
            }
        });

        // Apply theme colors to the time widget
        function applyTheme() {
            const timeCard = document.querySelector('.time-card');
            const displayTimeEl = document.querySelector('.display-time');

            // Apply background color with opacity
            const bgRgba = hexToRgba(theme.bgColor, theme.bgOpacity / 100);
            timeCard.style.backgroundColor = bgRgba;

            // Apply border color with opacity
            const borderRgba = hexToRgba(theme.borderColor, theme.borderOpacity / 100);
            timeCard.style.border = `3px solid ${borderRgba}`;
            //displayTimeEl.style.border = `2px solid ${borderRgba}`;

            // Apply text color
            displayTimeEl.style.color = theme.textColor;

            // Apply font family
            displayTimeEl.style.fontFamily = theme.fontFamily || 'Lato';

            displayTimeEl.style.fontSize = `${theme.fontSize || 5}px`;

            // Toggle Vanta background
            toggleVantaBackground(theme.bgCoverEnabled ?? true);

            // Apply hover effect with theme colors
            const hoverBgRgba = hexToRgba(theme.bgColor, 1);
            const style = document.createElement('style');
            style.id = 'dynamic-hover-style';

            // Remove old style if exists
            const oldStyle = document.getElementById('dynamic-hover-style');
            if (oldStyle) {
                oldStyle.remove();
            }

            style.textContent = `
                .display-time:hover {
                    background: ${hoverBgRgba} !important;
                    box-shadow: 0 0 30px ${hoverBgRgba} !important;
                    color: #272727 !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Convert hex to rgba with opacity
        function hexToRgba(hex, opacity) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // Update time display immediately
        function updateTimeDisplay() {
            let time = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: timezone
            };

            // Add seconds to options if showSeconds is true
            if (showSeconds) {
                options.second = '2-digit';
            }

            displayTime.innerText = time.toLocaleTimeString("en-US", options);
        }

        // Time display function
        function showTime() {
            updateTimeDisplay();
            setTimeout(showTime, 1000);
        }

        function sendCurrentSize() {
            let timeDialog = document.getElementById("timeDialog");
            const rect = timeDialog.getBoundingClientRect();
            ipcRenderer.send('resize-time', {
                width: Math.ceil(rect.width),
                height: Math.ceil(rect.height)
            });
        }

        function debouncedSendSize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                sendCurrentSize();
            }, 50);
        }

        // Initialize
        initVanta();
        loadSettings();
        showTime();

        // Send initial size after everything loads
        setTimeout(() => {
            sendCurrentSize();
        }, 1000);
    </script>
</body>

</html>
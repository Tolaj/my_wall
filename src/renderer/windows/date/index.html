<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Lato&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Arial&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Georgia&display=swap");
        @import url("https://fonts.googleapis.com/css2?family=Verdana&display=swap");

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .date-card {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            width: fit-content;
            height: fit-content;
        }

        .display-date {
            position: relative;
            z-index: 10;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            padding: 20px 40px;
            border-radius: 5px;
            transition: ease-in-out 0.1s;
            transition-property: background, box-shadow, color, border-color, font-family;
            -webkit-box-reflect: below 2px linear-gradient(transparent, rgba(255, 255, 255, 0.05));
            white-space: nowrap;
            display: inline-block;
        }

        .display-date:hover {
            cursor: pointer;
        }

        #dateDialog {
            -webkit-app-region: drag;
            overflow: hidden;
            width: fit-content;
            height: fit-content;
        }

        #vanta-bg {
            position: absolute;
            inset: 0;
            opacity: 0.3;
        }
    </style>
</head>

<body>
    <div id="dateDialog">
        <div id="dateDialogHead" class="date-card">
            <div id="vanta-bg"></div>
            <div class="display-date">
                <span id="day">day</span><span id="daynum">00</span> <span id="month">month</span> <span
                    id="year">0000</span>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require("electron");

        let vantaEffect = null;
        let resizeTimeout = null;
        let timezone = 'UTC';
        let dateUpdateInterval = null;
        let dateFormat = 'long';
        let previousBgCoverEnabled = true; // Track previous background state

        // Theme settings with defaults
        let theme = {
            bgColor: '#ffd868',
            bgOpacity: 98,
            borderColor: '#ffd868',
            borderOpacity: 100,
            textColor: '#ffd868',
            fontFamily: 'Lato',
            fontSize: 30,
            dateFormat: 'long',
            bgCoverEnabled: true
        };

        // Initialize Vanta.js background
        function initVanta() {
            if (vantaEffect) {
                vantaEffect.destroy();
            }

            vantaEffect = VANTA.WAVES({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: 0x1a1a2e,
                shininess: 30.00,
                waveHeight: 15.00,
                waveSpeed: 0.75,
                zoom: 0.65
            });
        }

        // Toggle Vanta background visibility
        function toggleVantaBackground(enabled) {
            const vantaBg = document.getElementById('vanta-bg');
            if (vantaBg) {
                vantaBg.style.display = enabled ? 'block' : 'none';
            }

            // Reinitialize Vanta when toggled on
            if (enabled && !vantaEffect) {
                initVanta();
            } else if (!enabled && vantaEffect) {
                vantaEffect.destroy();
                vantaEffect = null;
            }
        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('global_settings') || '{}');

            if (saved.dateSettings) {
                if (saved.dateSettings.timezone) {
                    timezone = saved.dateSettings.timezone;
                }

                if (saved.dateSettings.theme) {
                    theme = { ...theme, ...saved.dateSettings.theme };
                    previousBgCoverEnabled = theme.bgCoverEnabled ?? true;
                }

                if (saved.dateSettings.dateFormat) {
                    dateFormat = saved.dateSettings.dateFormat;
                }
            }

            applyTheme();
        }

        // Listen for settings updates from main process
        ipcRenderer.on('apply-date-settings', (event, settings) => {
            if (settings.dateSettings) {
                const timezoneChanged = settings.dateSettings.timezone &&
                    settings.dateSettings.timezone !== timezone;

                if (timezoneChanged) {
                    timezone = settings.dateSettings.timezone;
                    updateDate();
                }

                if (settings.dateSettings.theme) {
                    const newBgCoverEnabled = settings.dateSettings.theme.bgCoverEnabled ?? true;
                    // Check if background cover setting changed
                    if (newBgCoverEnabled !== previousBgCoverEnabled) {
                        previousBgCoverEnabled = newBgCoverEnabled;
                        theme = { ...theme, ...settings.dateSettings.theme };
                        applyTheme();
                        // Force Vanta reinitialize after a small delay
                        setTimeout(() => {
                            if (newBgCoverEnabled) {
                                initVanta();
                            }
                            sendCurrentSize();
                        }, 100);
                    } else {
                        theme = { ...theme, ...settings.dateSettings.theme };
                        applyTheme();
                    }
                }

                const formatChanged = settings.dateSettings.dateFormat &&
                    settings.dateSettings.dateFormat !== dateFormat;

                if (formatChanged) {
                    dateFormat = settings.dateSettings.dateFormat;
                    updateDate();
                }

                debouncedSendSize();
            }
        });

        // Date display function with format support
        function updateDate() {
            let today = new Date();

            if (dateFormat === 'long') {
                const dayName = today.toLocaleDateString("en-US", { weekday: "long", timeZone: timezone });
                const dayNum = today.toLocaleDateString("en-US", { day: "numeric", timeZone: timezone });
                const month = today.toLocaleDateString("en-US", { month: "long", timeZone: timezone });
                const year = today.toLocaleDateString("en-US", { year: "numeric", timeZone: timezone });

                document.getElementById("day").textContent = dayName + ', ';
                document.getElementById("daynum").textContent = dayNum + ' ';
                document.getElementById("month").textContent = month + ' ';
                document.getElementById("year").textContent = year;
            } else if (dateFormat === 'short') {
                const dayName = today.toLocaleDateString("en-US", { weekday: "short", timeZone: timezone });
                const dayNum = today.toLocaleDateString("en-US", { day: "numeric", timeZone: timezone });
                const month = today.toLocaleDateString("en-US", { month: "short", timeZone: timezone });
                const year = today.toLocaleDateString("en-US", { year: "numeric", timeZone: timezone });

                document.getElementById("day").textContent = dayName + ', ';
                document.getElementById("daynum").textContent = dayNum + ' ';
                document.getElementById("month").textContent = month + ' ';
                document.getElementById("year").textContent = year;
            } else if (dateFormat === 'numeric') {
                const formatted = today.toLocaleDateString("en-US", {
                    month: "2-digit",
                    day: "2-digit",
                    year: "numeric",
                    timeZone: timezone
                });

                document.getElementById("day").textContent = '';
                document.getElementById("daynum").textContent = formatted;
                document.getElementById("month").textContent = '';
                document.getElementById("year").textContent = '';
            } else if (dateFormat === 'iso') {
                const year = today.toLocaleDateString("en-US", { year: "numeric", timeZone: timezone });
                const month = today.toLocaleDateString("en-US", { month: "2-digit", timeZone: timezone });
                const day = today.toLocaleDateString("en-US", { day: "2-digit", timeZone: timezone });
                const formatted = `${year}-${month}-${day}`;

                document.getElementById("day").textContent = '';
                document.getElementById("daynum").textContent = formatted;
                document.getElementById("month").textContent = '';
                document.getElementById("year").textContent = '';
            }
        }

        // Apply theme colors to the date widget
        function applyTheme() {
            const dateCard = document.querySelector('.date-card');
            const displayDateEl = document.querySelector('.display-date');

            // Apply background color with opacity
            const bgRgba = hexToRgba(theme.bgColor, theme.bgOpacity / 100);
            dateCard.style.backgroundColor = bgRgba;

            // Apply border color with opacity
            const borderRgba = hexToRgba(theme.borderColor, theme.borderOpacity / 100);
            dateCard.style.border = `3px solid ${borderRgba}`;
            //displayDateEl.style.border = `2px solid ${borderRgba}`;

            // Apply text color
            displayDateEl.style.color = theme.textColor;

            // Apply font family
            displayDateEl.style.fontFamily = theme.fontFamily || 'Lato';

            displayDateEl.style.fontSize = `${theme.fontSize || 30}px`;


            // Toggle Vanta background
            toggleVantaBackground(theme.bgCoverEnabled ?? true);

            // Apply hover effect with theme colors
            const hoverBgRgba = hexToRgba(theme.bgColor, 1);
            const style = document.createElement('style');
            style.id = 'dynamic-hover-style';

            // Remove old style if exists
            const oldStyle = document.getElementById('dynamic-hover-style');
            if (oldStyle) {
                oldStyle.remove();
            }

            style.textContent = `
                .display-date:hover {
                    background: ${hoverBgRgba} !important;
                    box-shadow: 0 0 30px ${hoverBgRgba} !important;
                    color: #272727 !important;
                }
            `;
            document.head.appendChild(style);

        }

        // Convert hex to rgba with opacity
        function hexToRgba(hex, opacity) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // Setup date update interval
        function setupDateUpdate() {
            // Clear existing interval if any
            if (dateUpdateInterval) {
                clearInterval(dateUpdateInterval);
            }

            // Update date at midnight
            dateUpdateInterval = setInterval(() => {
                const now = new Date();
                const timeInTz = new Date(now.toLocaleString("en-US", { timeZone: timezone }));

                if (timeInTz.getHours() === 0 && timeInTz.getMinutes() === 0) {
                    updateDate();
                }
            }, 60000);
        }

        function sendCurrentSize() {
            let dateDialog = document.getElementById("dateDialog");
            const rect = dateDialog.getBoundingClientRect();
            ipcRenderer.send('resize-date', {
                width: Math.ceil(rect.width),
                height: Math.ceil(rect.height)
            });
        }

        function debouncedSendSize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                sendCurrentSize();
            }, 50);
        }

        // Initialize
        initVanta();
        loadSettings();
        updateDate();
        setupDateUpdate();

        // Send initial size after everything loads
        setTimeout(() => {
            sendCurrentSize();
        }, 1000);
    </script>
</body>

</html>